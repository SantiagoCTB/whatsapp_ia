{% extends 'base.html' %}
{% block title %}Reglas{% endblock %}
{% block body_class %}page{% endblock %}
{% block content %}
<div class="top-right">
    <a href="{{ url_for('chat.index') }}">
        <button class="back-btn btn-primary">Volver al inicio</button>
    </a>
</div>

<h2>Reglas</h2>
<p style="margin: 12px 0;">
    <a class="btn-primary" href="{{ url_for('configuracion.ia_settings') }}">Configurar modo IA conversacional</a>
</p>
<p>Para reglas de medición usa "*" en <em>Texto del usuario</em> y define la fórmula en <em>Cálculo</em> con variables como <code>medida</code>, <code>p1</code> o <code>p2</code>. El comodín "*" permite avanzar al siguiente paso sin validar el texto recibido: si es la única regla del paso se ejecutará automáticamente; si hay más reglas, actuará como opción por defecto. Opcionalmente indica un <em>Handler</em> para delegar el cálculo a código externo.</p>

<form id="reglaForm" method="POST" enctype="multipart/form-data">
    <h3>Agregar o actualizar regla</h3>
    <input type="hidden" id="regla_id" name="regla_id">
    <label for="step">Paso actual:</label>
    <input type="text" id="step" name="step" required>

    <label for="input_text">Texto del usuario (separa sinónimos con comas):</label>
    <input type="text" id="input_text" name="input_text" placeholder="palabra1, palabra2" required>

    <label for="respuesta">Respuesta del bot:</label>
    <textarea id="respuesta" name="respuesta" rows="4" required></textarea>

    <label for="siguiente_step">Siguiente paso (puedes ingresar varios pasos separados por comas):</label>
    <input type="text" id="siguiente_step" name="siguiente_step" placeholder="paso1, paso2">

    <label for="tipo">Tipo:</label>
    <select name="tipo" id="tipo" class="form-control">
        <option value="texto">Texto</option>
        <option value="boton">Botón</option>
        <option value="lista">Lista</option>
        <option value="image">Imagen</option>
        <option value="document">Documento</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
        <option value="flow">Flow</option>
    </select>

    <label for="media" id="label_media_file" style="display:none;">Subir archivo:</label>
    <input type="file" id="media" name="media[]" multiple style="display:none;">

    <label for="media_url" id="label_media_url" style="display:none;">URLs de archivos (separadas por comas o saltos de línea):</label>
    <textarea id="media_url" name="media_url" style="display:none;" placeholder="URL1, URL2&#10;URL3"></textarea>

    <label for="rol_keyword">Rol keyword:</label>
    <input type="text" id="rol_keyword" name="rol_keyword">

    <label for="calculo">Cálculo:</label>
    <input type="text" id="calculo" name="calculo">

    <label for="handler">Handler externo:</label>
    <input type="text" id="handler" name="handler">

    <label for="list_header" class="list-field" style="display:none;">Encabezado de la lista:</label>
    <input type="text" id="list_header" name="list_header" class="list-field" style="display:none;">

    <label for="list_button" class="list-field" style="display:none;">Texto del botón:</label>
    <input type="text" id="list_button" name="list_button" class="list-field" style="display:none;">

    <label for="list_footer" class="list-field" style="display:none;">Pie de página (opcional):</label>
    <input type="text" id="list_footer" name="list_footer" class="list-field" style="display:none;">

    <label for="button_options" class="button-field" style="display:none;">Opciones del botón (JSON):</label>
    <textarea id="button_options" name="button_options" class="button-field" style="display:none;" rows="4" cols="60" placeholder='[{"type":"reply","title":"Opción","id":"1"}]'></textarea>

    <label for="sections" class="list-field" style="display:none;">Secciones (formato JSON):</label><br>
    <textarea id="sections" name="sections" class="list-field" style="display:none;" rows="6" cols="60" placeholder='[{"title":"Rápido","rows":[{"id":"express","title":"Express","description":"1 día"}]}]'></textarea>

    <label for="flow_cta" class="flow-field" style="display:none;">CTA:</label>
    <input type="text" id="flow_cta" name="flow_cta" class="flow-field" style="display:none;">

    <label for="flow_id" class="flow-field" style="display:none;">Flow ID:</label>
    <input type="text" id="flow_id" name="flow_id" class="flow-field" style="display:none;">

    <label for="flow_name" class="flow-field" style="display:none;">Flow Name:</label>
    <input type="text" id="flow_name" name="flow_name" class="flow-field" style="display:none;">

    <label for="flow_version" class="flow-field" style="display:none;">Versión:</label>
    <input type="number" id="flow_version" name="flow_version" class="flow-field" style="display:none;" min="1" value="3">

    <label for="flow_mode" class="flow-field" style="display:none;">Modo:</label>
    <input type="text" id="flow_mode" name="flow_mode" class="flow-field" style="display:none;">

    <label for="flow_token" class="flow-field" style="display:none;">Token:</label>
    <input type="text" id="flow_token" name="flow_token" class="flow-field" style="display:none;">

    <label for="flow_action" class="flow-field" style="display:none;">Acción:</label>
    <select id="flow_action" name="flow_action" class="flow-field" style="display:none;">
        <option value="navigate">navigate</option>
        <option value="data_exchange">data_exchange</option>
    </select>

    <label for="flow_initial_screen" class="flow-field" style="display:none;">Pantalla inicial:</label>
    <input type="text" id="flow_initial_screen" name="flow_initial_screen" class="flow-field" style="display:none;">

    <label for="flow_payload" class="flow-field" style="display:none;">Payload (JSON):</label>
    <textarea id="flow_payload" name="flow_payload" class="flow-field" style="display:none;" rows="4" cols="60" placeholder='{"key":"value"}'></textarea>

    <label for="flow_header_text" class="flow-field" style="display:none;">Texto del header:</label>
    <input type="text" id="flow_header_text" name="flow_header_text" class="flow-field" style="display:none;">

    <label for="flow_footer_text" class="flow-field" style="display:none;">Texto del footer:</label>
    <input type="text" id="flow_footer_text" name="flow_footer_text" class="flow-field" style="display:none;">
    <input type="hidden" name="opciones" id="opciones">

    <button type="submit" class="btn-primary">Guardar regla</button>
</form>

<form method="POST" enctype="multipart/form-data">
    <h3>Importar reglas desde archivo Excel (.xlsx)</h3>
    <input type="file" name="archivo" accept=".xlsx" required>
    <button type="submit" class="btn-primary">Importar reglas</button>
</form>

<h3>Reglas existentes</h3>
<table class="fixed-table">
    <tr>
        <th>ID</th>
        <th>Paso</th>
        <th>Input</th>
        <th>Respuesta</th>
        <th>Siguiente paso</th>
        <th>Tipo</th>
        <th>Media URL</th>
        <th>Media Tipo</th>
        <th>Rol</th>
        <th>Opciones</th>
        <th>Encabezado</th>
        <th>Botón</th>
        <th>Pie</th>
        <th>Cálculo</th>
        <th>Handler</th>
        <th>Acción</th>
    </tr>
    {% for regla in reglas %}
    <tr>
        <td>{{ regla.id }}</td>
        <td>{{ regla.step }}</td>
        <td>{{ regla.input_text }}</td>
        <td>{{ regla.respuesta }}</td>
        <td>{{ regla.siguiente_step or '-' }}</td>
        <td>{{ regla.tipo }}</td>
        <td><pre style="white-space: pre-wrap;">{{ regla.media_urls|join('\n') if regla.media_urls else '-' }}</pre></td>
        <td><pre style="white-space: pre-wrap;">{{ regla.media_tipos|join('\n') if regla.media_tipos else '-' }}</pre></td>
        <td>{{ regla.rol_keyword or '-' }}</td>
        <td><pre style="white-space: pre-wrap;">{{ regla.opciones }}</pre></td>
        <td>{{ regla.header or '-' }}</td>
        <td>{{ regla.button or '-' }}</td>
        <td>{{ regla.footer or '-' }}</td>
        <td>{{ regla.calculo or '-' }}</td>
        <td>{{ regla.handler or '-' }}</td>
        <td class="action-cell">
            <form onsubmit="event.preventDefault();">
                <button class="edit-btn btn-primary" type="button" onclick='cargarRegla({{ regla|tojson }})'>Editar</button>
            </form>
            <form method="POST" action="{{ url_for('configuracion.eliminar_regla', regla_id=regla.id) }}">
                <button class="delete-btn btn-primary" type="submit">Eliminar</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>

<script>
function toggleMediaFields() {
    const tipo = document.getElementById('tipo').value;
    const show = ['image', 'video', 'audio', 'document'].includes(tipo);
    const mediaInput = document.getElementById('media');
    const mediaUrl   = document.getElementById('media_url');
    mediaInput.style.display = show ? 'block' : 'none';
    document.getElementById('label_media_file').style.display = show ? 'block' : 'none';
    mediaUrl.style.display = show ? 'block' : 'none';
    document.getElementById('label_media_url').style.display = show ? 'block' : 'none';
    if (!show) {
        mediaInput.value = '';
        mediaUrl.value = '';
    }
}

function toggleListFields() {
    const isList = document.getElementById('tipo').value === 'lista';
    document.querySelectorAll('.list-field').forEach(el => {
        el.style.display = isList ? 'block' : 'none';
    });
}

function toggleButtonFields() {
    const isButton = document.getElementById('tipo').value === 'boton';
    document.querySelectorAll('.button-field').forEach(el => {
        el.style.display = isButton ? 'block' : 'none';
    });
}

function toggleFlowFields() {
    const isFlow = document.getElementById('tipo').value === 'flow';
    document.querySelectorAll('.flow-field').forEach(el => {
        el.style.display = isFlow ? 'block' : 'none';
    });
}

function prepareOptions(e) {
    const tipo = document.getElementById('tipo').value;
    const opcionesInput = document.getElementById('opciones');
    if (tipo === 'lista') {
        const header = document.getElementById('list_header').value;
        const button = document.getElementById('list_button').value;
        const footer = document.getElementById('list_footer').value;
        const sectionsText = document.getElementById('sections').value;
        let sections;
        try {
            sections = JSON.parse(sectionsText || '[]');
        } catch (err) {
            sections = [];
        }

        const invalid = !Array.isArray(sections) || sections.length === 0 || sections.some(sec => !sec.rows || sec.rows.length === 0);
        if (invalid) {
            alert('Debes definir al menos una sección con una o más filas.');
            e.preventDefault();
            return;
        }

        const opts = {header, button, footer, sections};
        opcionesInput.value = JSON.stringify(opts);
    } else if (tipo === 'boton') {
        const text = document.getElementById('button_options').value.trim();
        if (text) {
            try {
                JSON.parse(text);
            } catch (err) {
                alert('El JSON de opciones de botón no es válido');
                e.preventDefault();
                return;
            }
        }
        opcionesInput.value = text;
    } else if (tipo === 'flow') {
        const cta = document.getElementById('flow_cta').value.trim();
        const flowId = document.getElementById('flow_id').value.trim();
        const flowName = document.getElementById('flow_name').value.trim();
        const flowVersionInput = document.getElementById('flow_version');
        const flowVersion = (flowVersionInput.value || flowVersionInput.getAttribute('value') || '3').toString().trim();
        const flowMode = document.getElementById('flow_mode').value.trim();
        const flowToken = document.getElementById('flow_token').value.trim();
        const flowAction = document.getElementById('flow_action').value;
        const flowInitialScreen = document.getElementById('flow_initial_screen').value.trim();
        const payloadText = document.getElementById('flow_payload').value.trim();
        const headerText = document.getElementById('flow_header_text').value.trim();
        const footerText = document.getElementById('flow_footer_text').value.trim();

        if (!cta) {
            alert('Debes ingresar un CTA para el flow.');
            e.preventDefault();
            return;
        }

        if (!flowId && !flowName) {
            alert('Debes ingresar un Flow ID o un Flow Name.');
            e.preventDefault();
            return;
        }

        if (!flowMode) {
            alert('Debes ingresar el modo del flow.');
            e.preventDefault();
            return;
        }

        let payload;
        if (payloadText) {
            try {
                payload = JSON.parse(payloadText);
            } catch (err) {
                alert('El payload del flow debe ser un JSON válido.');
                e.preventDefault();
                return;
            }
        }

        const parameters = {
            flow_cta: cta,
            flow_action: flowAction,
            flow_version: flowVersion || '3',
            flow_mode: flowMode
        };

        if (flowId) {
            parameters.flow_id = flowId;
        }

        if (flowName) {
            parameters.flow_name = flowName;
        }

        if (flowToken) {
            parameters.flow_token = flowToken;
        }

        if (flowInitialScreen) {
            parameters.flow_initial_screen = flowInitialScreen;
        }

        if (typeof payload !== 'undefined') {
            parameters.flow_action_payload = payload;
        }

        const opts = {
            header: { type: 'text', text: headerText },
            footer: { text: footerText },
            action: {
                name: 'flow',
                parameters
            }
        };

        opcionesInput.value = JSON.stringify(opts);
    } else {
        opcionesInput.value = '';
    }
}
document.getElementById('tipo').addEventListener('change', () => {
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
});
const form = document.getElementById('reglaForm');
form.addEventListener('submit', prepareOptions);
window.addEventListener('DOMContentLoaded', () => {
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
});

function cargarRegla(regla) {
    document.getElementById('regla_id').value = regla.id;
    document.getElementById('step').value = regla.step || '';
    document.getElementById('input_text').value = regla.input_text || '';
    document.getElementById('respuesta').value = regla.respuesta || '';
    document.getElementById('siguiente_step').value = regla.siguiente_step || '';
    document.getElementById('tipo').value = regla.tipo || 'texto';
    document.getElementById('media').value = '';
    document.getElementById('media_url').value = (regla.media_urls || []).filter(u => u).join('\n');
    document.getElementById('rol_keyword').value = regla.rol_keyword || '';
    document.getElementById('calculo').value = regla.calculo || '';
    document.getElementById('handler').value = regla.handler || '';
    document.getElementById('list_header').value = regla.header || '';
    document.getElementById('list_button').value = regla.button || '';
    document.getElementById('list_footer').value = regla.footer || '';
    document.getElementById('sections').value = '';
    document.getElementById('button_options').value = '';
    document.getElementById('opciones').value = '';
    document.getElementById('flow_cta').value = '';
    document.getElementById('flow_id').value = '';
    document.getElementById('flow_name').value = '';
    document.getElementById('flow_version').value = '3';
    document.getElementById('flow_mode').value = '';
    document.getElementById('flow_token').value = '';
    document.getElementById('flow_action').value = 'navigate';
    document.getElementById('flow_initial_screen').value = '';
    document.getElementById('flow_payload').value = '';
    document.getElementById('flow_header_text').value = '';
    document.getElementById('flow_footer_text').value = '';
    if (regla.tipo === 'lista' && regla.opciones) {
        try {
            const opts = JSON.parse(regla.opciones);
            document.getElementById('list_header').value = opts.header || '';
            document.getElementById('list_button').value = opts.button || '';
            document.getElementById('list_footer').value = opts.footer || '';
            document.getElementById('sections').value = JSON.stringify(opts.sections || []);
            document.getElementById('opciones').value = JSON.stringify(opts);
        } catch (e) {
            document.getElementById('opciones').value = regla.opciones || '';
        }
    } else if (regla.tipo === 'boton') {
        document.getElementById('button_options').value = regla.opciones || '';
        document.getElementById('opciones').value = regla.opciones || '';
    } else if (regla.tipo === 'flow' && regla.opciones) {
        let opts = null;
        try {
            opts = typeof regla.opciones === 'string' ? JSON.parse(regla.opciones) : regla.opciones;
        } catch (e) {
            opts = null;
        }

        if (opts) {
            const header = opts.header && (opts.header.text || opts.header.value || '');
            const footer = opts.footer && (opts.footer.text || '');
            document.getElementById('flow_header_text').value = header || '';
            document.getElementById('flow_footer_text').value = footer || '';

            const params = (opts.action && opts.action.parameters) || {};
            document.getElementById('flow_cta').value = params.flow_cta || '';
            document.getElementById('flow_id').value = params.flow_id || '';
            document.getElementById('flow_name').value = params.flow_name || '';
            document.getElementById('flow_version').value = params.flow_version || '3';
            document.getElementById('flow_mode').value = params.flow_mode || '';
            document.getElementById('flow_token').value = params.flow_token || '';
            document.getElementById('flow_action').value = params.flow_action || 'navigate';
            document.getElementById('flow_initial_screen').value = params.flow_initial_screen || '';
            if (params.flow_action_payload) {
                document.getElementById('flow_payload').value = JSON.stringify(params.flow_action_payload, null, 2);
            }
            document.getElementById('opciones').value = JSON.stringify(opts);
        } else {
            document.getElementById('opciones').value = regla.opciones || '';
        }
    } else {
        document.getElementById('opciones').value = regla.opciones || '';
    }
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
}
</script>
{% endblock %}
